<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Assistant IA - GitHub Discovery</title>
  <link rel="stylesheet" href="assets/styles.css">
</head>
<body>
  <nav class="navbar">
    <div class="nav-left">
      <div class="logo" onclick="window.location.href='index.html'">
        ğŸ” GitHub Discovery
      </div>
    </div>
    
    <div class="nav-center">
      <a href="explore.html" class="nav-link">ğŸ” Explorer</a>
      <a href="assistant.html" class="nav-link active">ğŸ¤– Assistant IA</a>
    </div>
    
    <div class="nav-right">
      <span id="userName">Chargement...</span>
      <button onclick="window.location.href='profile.html'" class="btn-profile">ğŸ‘¤</button>
      <button onclick="logout()" class="btn-logout">DÃ©connexion</button>
    </div>
  </nav>

  <div class="container">
    <div class="header">
      <h1>ğŸ¤– Assistant IA</h1>
      <p>DÃ©crivez votre projet, l'IA vous recommande les meilleurs outils</p>
    </div>

    <div class="assistant-container">
      <div class="chat-area">
        <div class="chat-messages" id="chatMessages">
          <div class="ai-message">
            <div class="message-avatar">ğŸ¤–</div>
            <div class="message-content">
              <p><strong>Bonjour !</strong></p>
              <p>Je suis votre assistant IA pour la dÃ©couverte de projets GitHub.</p>
              <p>DÃ©crivez-moi ce que vous voulez construire, et je vous recommanderai les meilleurs outils et bibliothÃ¨ques.</p>
              <p><em>Exemples :</em></p>
              <ul>
                <li>"Je veux crÃ©er une API REST en Python"</li>
                <li>"J'ai besoin d'une bibliothÃ¨que d'authentification JavaScript"</li>
                <li>"Recommande-moi un framework UI moderne"</li>
              </ul>
            </div>
          </div>
        </div>

        <div class="chat-input-area">
          <textarea 
            id="userInput" 
            placeholder="DÃ©crivez votre besoin..."
            rows="3"
            onkeydown="if(event.key==='Enter' && !event.shiftKey){event.preventDefault();sendMessage();}"
          ></textarea>
          <button onclick="sendMessage()" class="btn-send" id="sendBtn">
            Envoyer ğŸš€
          </button>
        </div>
      </div>

      <div class="suggestions-panel">
        <h3>ğŸ’¡ Suggestions rapides</h3>
        <div class="quick-suggestions">
          <button class="suggestion-chip" onclick="quickQuery('API REST Python')">
            ğŸ API REST Python
          </button>
          <button class="suggestion-chip" onclick="quickQuery('Authentification JavaScript')">
            ğŸ” Auth JavaScript
          </button>
          <button class="suggestion-chip" onclick="quickQuery('Framework UI moderne')">
            ğŸ¨ Framework UI
          </button>
          <button class="suggestion-chip" onclick="quickQuery('Base de donnÃ©es ORM')">
            ğŸ—„ï¸ Database ORM
          </button>
          <button class="suggestion-chip" onclick="quickQuery('Tests automatisÃ©s')">
            ğŸ§ª Testing
          </button>
          <button class="suggestion-chip" onclick="quickQuery('CLI TypeScript')">
            âŒ¨ï¸ CLI TypeScript
          </button>
        </div>
      </div>
    </div>
  </div>

  <script src="assets/auth.js"></script>
  <script>
    const chatMessages = document.getElementById('chatMessages');
    const userInput = document.getElementById('userInput');
    const sendBtn = document.getElementById('sendBtn');

    function quickQuery(query) {
      userInput.value = query;
      sendMessage();
    }

    async function sendMessage() {
      const message = userInput.value.trim();
      
      if (!message) return;

      // Afficher message utilisateur
      addUserMessage(message);
      userInput.value = '';
      sendBtn.disabled = true;
      sendBtn.textContent = 'Analyse...';

      // Afficher loading
      const loadingId = addLoadingMessage();

      try {
        const response = await fetch('/api/assistant/recommend', {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('token')}`
          },
          body: JSON.stringify({ 
            query: message,
            context: {}
          })
        });

        const data = await response.json();

        // Retirer loading
        removeLoadingMessage(loadingId);

        if (data.success) {
          addAIResponse(data);
        } else {
          addErrorMessage(data.message || 'Erreur lors de l\'analyse');
        }

      } catch (error) {
        console.error('Error:', error);
        removeLoadingMessage(loadingId);
        addErrorMessage('Erreur de connexion');
      } finally {
        sendBtn.disabled = false;
        sendBtn.textContent = 'Envoyer ğŸš€';
      }
    }

    function addUserMessage(text) {
      const messageDiv = document.createElement('div');
      messageDiv.className = 'user-message';
      messageDiv.innerHTML = `
        <div class="message-content">
          <p>${escapeHtml(text)}</p>
        </div>
        <div class="message-avatar">ğŸ‘¤</div>
      `;
      chatMessages.appendChild(messageDiv);
      scrollToBottom();
    }

    function addLoadingMessage() {
      const loadingDiv = document.createElement('div');
      loadingDiv.className = 'ai-message loading-message';
      loadingDiv.id = 'loading-' + Date.now();
      loadingDiv.innerHTML = `
        <div class="message-avatar">ğŸ¤–</div>
        <div class="message-content">
          <p>Analyse en cours...</p>
          <div class="loading-dots">
            <span></span><span></span><span></span>
          </div>
        </div>
      `;
      chatMessages.appendChild(loadingDiv);
      scrollToBottom();
      return loadingDiv.id;
    }

    function removeLoadingMessage(loadingId) {
      const loadingDiv = document.getElementById(loadingId);
      if (loadingDiv) loadingDiv.remove();
    }

    function addAIResponse(data) {
      const messageDiv = document.createElement('div');
      messageDiv.className = 'ai-message';
      
      let html = `
        <div class="message-avatar">ğŸ¤–</div>
        <div class="message-content">
      `;

      // Intent dÃ©tectÃ©
      if (data.intent) {
        html += `<p><strong>J'ai dÃ©tectÃ© :</strong></p><ul>`;
        if (data.intent.detected_language) {
          html += `<li>Langage : ${data.intent.detected_language}</li>`;
        }
        if (data.intent.detected_category) {
          html += `<li>CatÃ©gorie : ${getCategoryLabel(data.intent.detected_category)}</li>`;
        }
        html += `</ul>`;
      }

      // Recommandations
      if (data.recommendations && data.recommendations.length > 0) {
        html += `<p><strong>Voici mes recommandations :</strong></p>`;
        
        data.recommendations.slice(0, 5).forEach((project, index) => {
          html += `
            <div class="recommendation-card" onclick="window.location.href='project.html?id=${project.id}'">
              <div class="rec-header">
                <span class="rec-number">#${index + 1}</span>
                <strong>${project.name}</strong>
                <span class="language-badge">${project.language || 'N/A'}</span>
              </div>
              <p>${project.description || 'Pas de description'}</p>
              <div class="rec-meta">
                <span>â­ ${project.stars}</span>
                <span>ğŸ’ ${project.utility_score ? project.utility_score.toFixed(1) : 'N/A'}/10</span>
              </div>
            </div>
          `;
        });
      } else {
        html += `<p>Aucun projet correspondant trouvÃ©. Essayez une recherche diffÃ©rente.</p>`;
      }

      html += `</div>`;
      messageDiv.innerHTML = html;
      chatMessages.appendChild(messageDiv);
      scrollToBottom();
    }

    function addErrorMessage(text) {
      const messageDiv = document.createElement('div');
      messageDiv.className = 'ai-message error-message';
      messageDiv.innerHTML = `
        <div class="message-avatar">âŒ</div>
        <div class="message-content">
          <p>${escapeHtml(text)}</p>
        </div>
      `;
      chatMessages.appendChild(messageDiv);
      scrollToBottom();
    }

    function scrollToBottom() {
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function getCategoryLabel(category) {
      const labels = {
        'authentication': 'ğŸ” Authentification',
        'api': 'ğŸ”Œ API',
        'database': 'ğŸ—„ï¸ Base de donnÃ©es',
        'ui': 'ğŸ¨ Interface utilisateur',
        'framework': 'ğŸ—ï¸ Framework',
        'cli': 'âŒ¨ï¸ CLI',
        'testing': 'ğŸ§ª Testing'
      };
      return labels[category] || category;
    }

    function logout() {
      localStorage.removeItem('token');
      localStorage.removeItem('user');
      window.location.href = 'login.html';
    }

    // Check auth et charger donnÃ©es
    checkAuth();
    loadUserInfo();
  </script>
</body>
</html>